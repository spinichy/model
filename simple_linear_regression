##Step1. #Data Collection

library(regbook)
regbook::hweight


##Step2. Data processing and exploration

#1processing 
str(hweight)
sum(is.na(hweight)) #No NA value

library(mice)
md.pattern(x = hweight) #No NA value


#2exploration

#summary
summary(hweight)

#boxplot
library(ggplot2)
ggplot(data = hweight, 
       mapping = aes(x = height, y= weight, color = gender)) + 
  geom_boxplot() + 
  theme_bw()

#scatter plot
plot(weight ~ height, data = hweight)

#correlation
with(data = hweight, expr = cor(height, weight)) #0.7335482


##Step3. Train Model

#simple linear regression - gender: Male
library(tidyverse)
hweight_M <- hweight %>% 
  filter(gender == "M")
lm_hweight_M <- lm(weight ~ height, data = hweight_M)
summary(lm_hweight_M)

#simple linear regression - gender: Female
hweight_F <- hweight %>% 
  filter(gender == "F")
lm_hweight_F <- lm(weight ~ height, data = hweight_F)
summary(lm_hweight_F)

#simple linear regression - gender: Male + Female
lm_hweight <- lm(weight ~ height, data = hweight)
summary(lm_hweight)


##Step4. Evaluation Model

#residual analysis
par(mfrow = c(2,2))
plot(lm_hweight)

#Normality test
shapiro.test(lm_hweight$residuals)

#independence test
par(mfrow = c(1,1))
n <- length(lm_hweight$residuals)
plot(x = 1:n, y = lm_hweight$residuals, 
     xlab = "Observation Order", ylab = "residuals")


##Step5. Improve Model
summary(lm_hweight)


#PRESS
SSE <- sum((lm_hweight$residuals)^2)
library(regbook)
PRESS <- sum(rpredict(lm_hweight)^2)
SST <- sum((hweight$weight - mean(hweight$weight))^2)

R <- 1 - SSE/SST;R
R2 <- 1 - PRESS/SST;R2

#logic of PRESS 
result <- c()
for(i in 1:nrow(lm_hweight$model)) {
  model <- lm(weight ~ height, data = lm_hweight$model[-i,]);model
  y_hat_press <- predict( object = model, newdata = list(height = lm_hweight$model[i,2]) )
  y_real <- lm_hweight$model[i,1]
  result[i] <- y_real - y_hat_press
}
round(PRESS - sum(result^2),)


#confidence interval by coeeficients
confint(lm_hweight, level = 0.95)

#logic of confidence interval by coeeficients
t_value <- qt(p = 0.05/2, df = lm_hweight$df.residual, lower.tail = FALSE)
lm_hweight_summ <- summary(lm_hweight)
Std.Error_beto0 <- lm_hweight_summ$coefficients[1,2]
Std.Error_beto1 <- lm_hweight_summ$coefficients[2,2]
coef(lm_hweight)[1] + c(-1,1)*t_value*Std.Error_beto0 
coef(lm_hweight)[2] + c(-1,1)*t_value*Std.Error_beto1


#Confidence and Prediction interval
predict(lm_hweight, se.fit = TRUE) # se.fit = TRUE => Std.Error by point
predict(lm_hweight, interval = "confidence")
predict(lm_hweight, interval = "prediction")
library(regbook)
fitplot(lm_hweight)

loess_line <- loess.smooth(x = hweight$height, y = hweight$weight)
lines(x = loess_line$x, y = loess_line$y, col = "red")

legend("topleft", lty = c(1,1,2,1), 
       legend = c("fit", "95% confidence band", "95% prediction band","loess smooth"), 
       col = c("black","gray", "black","red"), lwd = c(1,5,1,1))

#logic of Confidence and Prediction interval
MSE <- sum(lm_hweight$residuals^2)/lm_hweight$df.residual
fn_var_y <- function(MSE, x, dfx) {
  n <- length(dfx)
  xbar <- mean(dfx)
  Sxx <- sum((dfx - xbar)^2)
  
  value <- sqrt( MSE*((1/n) + (x-xbar)^2/Sxx) )
  return(value)
}

s.1 <- fn_var_y(MSE = MSE, x = lm_hweight$model$height[1], dfx = lm_hweight$model$height)
t_value <- qt(p = 0.05/2, df = lm_hweight$df.residual, lower.tail = FALSE)
fitted(lm_hweight)[1] + c(-1,1)*t_value*s.1


MSE <- sum(lm_hweight$residuals^2)/lm_hweight$df.residual
fn_var_y_pred <- function(MSE, x, dfx) {
  n <- length(dfx)
  xbar <- mean(dfx)
  Sxx <- sum((dfx - xbar)^2)
  
  value <- sqrt( MSE*(1 + (1/n) + (x-xbar)^2/Sxx) )
  return(value)
}

s.1 <- fn_var_y_pred(MSE = MSE, x = lm_hweight$model$height[1], dfx = lm_hweight$model$height)
t_value <- qt(p = 0.05/2, df = lm_hweight$df.residual, lower.tail = FALSE)
fitted(lm_hweight)[1] + c(-1,1)*t_value*s.1
